#!/bin/bash

# Script de Testes Cient√≠ficos Automatizados - ESP32-CAM
# Gabriel Passos - UNESP 2025

set -e

# Cores para output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo -e "${BLUE}========================================${NC}"
echo -e "${BLUE}üî¨ Testes Cient√≠ficos ESP32-CAM${NC}"
echo -e "${BLUE}üìä Coleta de Dados para Artigo${NC}"
echo -e "${BLUE}Gabriel Passos - UNESP 2025${NC}"
echo -e "${BLUE}========================================${NC}"

# Verificar se estamos no diret√≥rio correto
if [ -f "../esp32/main/main.c" ] && [ -f "../server/ic_monitor.py" ]; then
    # Executado de dentro da pasta scripts/
    cd ..
elif [ ! -f "esp32/main/main.c" ] || [ ! -f "server/ic_monitor.py" ]; then
    # N√£o est√° nem na raiz nem em scripts/
    echo -e "${RED}‚ùå Erro: Execute este script a partir da pasta raiz do projeto${NC}"
    echo -e "${YELLOW}üí° Use: ./scripts/run_scientific_tests.sh${NC}"
    exit 1
fi

# Fun√ß√£o para verificar se o servidor est√° rodando
check_server() {
    if pgrep -f "ic_monitor.py" > /dev/null; then
        return 0
    else
        return 1
    fi
}

# Fun√ß√£o para iniciar servidor de monitoramento
start_monitoring_server() {
    echo -e "${YELLOW}üì° Iniciando servidor de monitoramento cient√≠fico...${NC}"
    
    cd server
    
    # Verificar depend√™ncias Python
    if ! python3 -c "import paho.mqtt.client, sqlite3, json" 2>/dev/null; then
        echo -e "${YELLOW}üì¶ Instalando depend√™ncias Python...${NC}"
        pip3 install paho-mqtt sqlite3 || echo "Algumas depend√™ncias podem j√° estar instaladas"
    fi
    
    # Iniciar servidor em background
    nohup python3 ic_monitor.py > ../logs/monitor.log 2>&1 &
    SERVER_PID=$!
    
    cd ..
    
    # Aguardar servidor inicializar
    sleep 5
    
    if check_server; then
        echo -e "${GREEN}‚úÖ Servidor de monitoramento iniciado (PID: $SERVER_PID)${NC}"
        echo $SERVER_PID > .server_pid
        return 0
    else
        echo -e "${RED}‚ùå Falha ao iniciar servidor de monitoramento${NC}"
        return 1
    fi
}

# Fun√ß√£o para parar servidor
stop_monitoring_server() {
    if [ -f ".server_pid" ]; then
        SERVER_PID=$(cat .server_pid)
        if kill $SERVER_PID 2>/dev/null; then
            echo -e "${GREEN}‚úÖ Servidor de monitoramento parado${NC}"
        fi
        rm -f .server_pid
    fi
    
    # Garantir que todos os processos sejam mortos
    pkill -f "ic_monitor.py" 2>/dev/null || true
}

# Fun√ß√£o para compilar e flash vers√£o espec√≠fica
deploy_version() {
    local version=$1
    echo -e "${YELLOW}üîÑ Alternando para vers√£o $version...${NC}"
    
    # Usar script de altern√¢ncia
    if [ "$version" = "intelligent" ]; then
        echo "1" | bash scripts/switch_version.sh
    elif [ "$version" = "simple" ]; then
        echo "2" | bash scripts/switch_version.sh
    else
        echo -e "${RED}‚ùå Vers√£o inv√°lida: $version${NC}"
        return 1
    fi
    
    # Compilar e fazer flash
    echo -e "${YELLOW}üî® Compilando vers√£o $version...${NC}"
    cd esp32
    
    if idf.py build; then
        echo -e "${GREEN}‚úÖ Compila√ß√£o bem-sucedida${NC}"
        
        echo -e "${YELLOW}üì± Fazendo flash da vers√£o $version...${NC}"
        echo -e "${BLUE}üîå Conecte o ESP32-CAM e pressione ENTER quando estiver pronto${NC}"
        read -p "Pressione ENTER para continuar..."
        
        if idf.py flash; then
            echo -e "${GREEN}‚úÖ Flash bem-sucedido${NC}"
            echo -e "${BLUE}üîÑ Aguarde o ESP32 reinicializar...${NC}"
            sleep 10
            return 0
        else
            echo -e "${RED}‚ùå Falha no flash${NC}"
            return 1
        fi
    else
        echo -e "${RED}‚ùå Falha na compila√ß√£o${NC}"
        return 1
    fi
    
    cd ..
}

# Fun√ß√£o para executar teste
run_test() {
    local version=$1
    local test_name=$2
    local duration=$3
    
    echo -e "${BLUE}üß™ === INICIANDO TESTE: $test_name ($version) ===${NC}"
    echo -e "${BLUE}‚è±Ô∏è  Dura√ß√£o: $duration minutos${NC}"
    echo -e "${BLUE}üìä Coletando dados...${NC}"
    
    # Aguardar estabiliza√ß√£o
    echo -e "${YELLOW}‚è≥ Aguardando estabiliza√ß√£o do sistema (30s)...${NC}"
    sleep 30
    
    # Mostrar countdown
    local seconds=$((duration * 60))
    echo -e "${GREEN}üöÄ Teste iniciado! Monitorando por $duration minutos...${NC}"
    
    # Loop de monitoramento
    local elapsed=0
    while [ $elapsed -lt $seconds ]; do
        local remaining=$((seconds - elapsed))
        local min=$((remaining / 60))
        local sec=$((remaining % 60))
        
        printf "\r${YELLOW}‚è±Ô∏è  Tempo restante: %02d:%02d${NC}" $min $sec
        
        sleep 10
        elapsed=$((elapsed + 10))
        
        # Verificar se o servidor ainda est√° rodando
        if ! check_server; then
            echo -e "\n${RED}‚ùå Servidor de monitoramento parou! Reiniciando...${NC}"
            start_monitoring_server
        fi
    done
    
    echo -e "\n${GREEN}‚úÖ Teste $test_name conclu√≠do!${NC}"
    
    # Aguardar processamento final
    echo -e "${YELLOW}üìä Aguardando processamento final dos dados...${NC}"
    sleep 30
}

# Fun√ß√£o para gerar relat√≥rios
generate_reports() {
    echo -e "${YELLOW}üìä Gerando relat√≥rios cient√≠ficos...${NC}"
    
    # Verificar se existem dados nos bancos
    if [ -f "data/databases/monitoring_intelligent.db" ] || [ -f "data/databases/monitoring_simple.db" ]; then
        # Gerar relat√≥rios
        if cd scripts && python3 scientific_report.py; then
            echo -e "${GREEN}‚úÖ Relat√≥rios gerados com sucesso${NC}"
            
            # Mostrar arquivos gerados
            if [ -d "../data/reports" ]; then
                echo -e "${BLUE}üìÅ Arquivos gerados:${NC}"
                ls -la ../data/reports/
                
                if [ -d "../data/reports/plots" ]; then
                    echo -e "${BLUE}üìà Gr√°ficos gerados:${NC}"
                    ls -la ../data/reports/plots/
                fi
            fi
        else
            echo -e "${YELLOW}‚ö†Ô∏è  Relat√≥rios gerados com dados simulados${NC}"
        fi
    else
        echo -e "${YELLOW}‚ö†Ô∏è  Nenhum dado coletado. Gerando relat√≥rio com dados simulados...${NC}"
        cd scripts && python3 scientific_report.py
    fi
    
    # Voltar para pasta raiz
    cd ..
}

# Fun√ß√£o para backup dos dados
backup_data() {
    local timestamp=$(date +"%Y%m%d_%H%M%S")
    local backup_dir="backup_scientific_$timestamp"
    
    echo -e "${YELLOW}üíæ Fazendo backup dos dados...${NC}"
    
    mkdir -p "$backup_dir"
    
    # Backup dos bancos de dados
    if [ -f "data/databases/monitoring_intelligent.db" ]; then
        cp "data/databases/monitoring_intelligent.db" "$backup_dir/"
    fi
    
    if [ -f "data/databases/monitoring_simple.db" ]; then
        cp "data/databases/monitoring_simple.db" "$backup_dir/"
    fi
    
    # Backup dos dados
    if [ -d "data" ]; then
        cp -r "data" "$backup_dir/"
    fi
    
    # Backup dos logs
    if [ -d "logs" ]; then
        cp -r "logs" "$backup_dir/"
    fi
    
    echo -e "${GREEN}‚úÖ Backup salvo em: $backup_dir${NC}"
}

# Menu principal
main_menu() {
    echo -e "\n${YELLOW}üî¨ Escolha o tipo de teste:${NC}"
    echo -e "   ${GREEN}1)${NC} Teste Completo Automatizado (2 vers√µes, 3 cen√°rios)"
    echo -e "   ${GREEN}2)${NC} Teste Individual - Vers√£o Inteligente"
    echo -e "   ${GREEN}3)${NC} Teste Individual - Vers√£o Simples"
    echo -e "   ${GREEN}4)${NC} Apenas gerar relat√≥rios dos dados existentes"
    echo -e "   ${GREEN}5)${NC} Backup dos dados coletados"
    echo -e "   ${GREEN}6)${NC} Limpar dados anteriores"
    echo -e "   ${GREEN}0)${NC} Sair"
    
    read -p "üéØ Escolha uma op√ß√£o: " choice
    
    case $choice in
        1)
            run_complete_tests
            ;;
        2)
            run_individual_test "intelligent"
            ;;
        3)
            run_individual_test "simple"
            ;;
        4)
            generate_reports
            ;;
        5)
            backup_data
            ;;
        6)
            clean_previous_data
            ;;
        0)
            echo -e "${GREEN}üëã Saindo...${NC}"
            stop_monitoring_server
            exit 0
            ;;
        *)
            echo -e "${RED}‚ùå Op√ß√£o inv√°lida!${NC}"
            main_menu
            ;;
    esac
}

# Fun√ß√£o para teste completo
run_complete_tests() {
    echo -e "${BLUE}üöÄ === INICIANDO TESTES CIENT√çFICOS COMPLETOS ===${NC}"
    
    # Criar diret√≥rios
    mkdir -p logs
    
    # Iniciar servidor de monitoramento
    if ! start_monitoring_server; then
        echo -e "${RED}‚ùå Falha ao iniciar monitoramento. Abortando testes.${NC}"
        return 1
    fi
    
    # Teste da vers√£o inteligente
    echo -e "\n${BLUE}üß† === TESTANDO VERS√ÉO INTELIGENTE ===${NC}"
    if deploy_version "intelligent"; then
        run_test "intelligent" "Baseline Est√°tico" 10
        echo -e "${BLUE}üìù Anote quaisquer observa√ß√µes sobre o teste...${NC}"
        read -p "Pressione ENTER para continuar para o pr√≥ximo teste..."
        
        run_test "intelligent" "Movimento Controlado" 10
        echo -e "${BLUE}üìù Execute movimentos conforme documentado...${NC}"
        read -p "Pressione ENTER para continuar..."
    fi
    
    # Teste da vers√£o simples
    echo -e "\n${BLUE}üì∑ === TESTANDO VERS√ÉO SIMPLES ===${NC}"
    if deploy_version "simple"; then
        run_test "simple" "Baseline Est√°tico" 10
        echo -e "${BLUE}üìù Anote quaisquer observa√ß√µes sobre o teste...${NC}"
        read -p "Pressione ENTER para continuar para o pr√≥ximo teste..."
        
        run_test "simple" "Movimento Controlado" 10
        echo -e "${BLUE}üìù Execute os mesmos movimentos do teste anterior...${NC}"
        read -p "Pressione ENTER para continuar..."
    fi
    
    # Parar servidor e gerar relat√≥rios
    stop_monitoring_server
    generate_reports
    backup_data
    
    echo -e "\n${GREEN}üéâ === TESTES CIENT√çFICOS CONCLU√çDOS ===${NC}"
    echo -e "${GREEN}üìä Dados coletados e relat√≥rios gerados${NC}"
    echo -e "${GREEN}üìÅ Verifique a pasta data/reports/ para os resultados${NC}"
}

# Fun√ß√£o para teste individual
run_individual_test() {
    local version=$1
    
    echo -e "${BLUE}üß™ === TESTE INDIVIDUAL: VERS√ÉO $version ===${NC}"
    
    mkdir -p logs
    
    if ! start_monitoring_server; then
        echo -e "${RED}‚ùå Falha ao iniciar monitoramento${NC}"
        return 1
    fi
    
    if deploy_version "$version"; then
        echo -e "${YELLOW}üî¨ Escolha o tipo de teste:${NC}"
        echo -e "   1) Baseline Est√°tico (10 min)"
        echo -e "   2) Movimento Controlado (10 min)"
        echo -e "   3) Cen√°rio Real (30 min)"
        
        read -p "Escolha: " test_type
        
        case $test_type in
            1)
                run_test "$version" "Baseline Est√°tico" 10
                ;;
            2)
                run_test "$version" "Movimento Controlado" 10
                ;;
            3)
                run_test "$version" "Cen√°rio Real" 30
                ;;
            *)
                echo -e "${RED}‚ùå Op√ß√£o inv√°lida${NC}"
                ;;
        esac
    fi
    
    stop_monitoring_server
    generate_reports
}

# Fun√ß√£o para limpar dados anteriores
clean_previous_data() {
    echo -e "${YELLOW}‚ö†Ô∏è  Esta opera√ß√£o ir√° apagar todos os dados coletados anteriormente${NC}"
    read -p "Tem certeza? (s/N): " confirm
    
    if [[ $confirm == "s" || $confirm == "S" ]]; then
        echo -e "${YELLOW}üßπ Limpando dados anteriores...${NC}"
        
        rm -f data/databases/monitoring_*.db
        rm -rf data/
        rm -rf logs/
        
        echo -e "${GREEN}‚úÖ Dados limpos${NC}"
    else
        echo -e "${BLUE}‚ÑπÔ∏è  Opera√ß√£o cancelada${NC}"
    fi
}

# Trap para cleanup em caso de interrup√ß√£o
trap 'echo -e "\n${YELLOW}üõë Interrup√ß√£o detectada. Limpando...${NC}"; stop_monitoring_server; exit 1' INT

# Verificar depend√™ncias
echo -e "${YELLOW}üîç Verificando depend√™ncias...${NC}"

if ! command -v python3 &> /dev/null; then
    echo -e "${RED}‚ùå Python3 n√£o encontrado${NC}"
    exit 1
fi

if ! command -v idf.py &> /dev/null; then
    echo -e "${RED}‚ùå ESP-IDF n√£o encontrado${NC}"
    exit 1
fi

echo -e "${GREEN}‚úÖ Depend√™ncias verificadas${NC}"

# Executar menu principal
main_menu 